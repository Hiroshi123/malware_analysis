#include <winsock2.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>

#include <string.h>
#include "server.h"

int main(int argc, char **argv)
{
  if (argc < 2) {
    printf("need private key\n");
    return 0;
  }
  void* prvkey = crypt_init(argv[1]);
  void* pubkey = crypt_debug_init(argv[2]);
  
  printf("aaa\n");
  
  char* outfile = 0;
  uint8_t* buf = malloc(0x10);
  uint8_t* b = buf;
  // *buf = 0x12345678;
  memset(buf, 0, 0x10);
  uint8_t* e = buf + 0x10;
  for (;buf < e;buf++) {
    *buf = '1';// 0x30;
  }
  
  char pass = "Password";
  void* key;
  void* iv;
  derive_key(pass, &key, &iv);
  
  crypt_encrypt(b, 1, key, iv);  
  crypt_decrypt(b, 1/*16*/);
  
  // crypt_rsa_sign(prvkey, 16, buf);
  
  // void* sig = crypt_sign(prvkey, buf, 4);
  
  // void* sig = crypt_sign(prvkey, buf, 4);
  // crypt_verify(pubkey, buf, 4, sig, 128);
  return 0;
  
  int addr_len;
  struct sockaddr_in local, client_addr;
  
  SOCKET sock, msg_sock;
  WSADATA wsaData;
  
  if (WSAStartup(MAKEWORD(2, 2), &wsaData) == SOCKET_ERROR)
    error_die("WSAStartup()");
  printf("wsa startup done\n");

  // Fill in the address structure
  local.sin_family        = AF_INET;
  local.sin_addr.s_addr   = INADDR_ANY;
  local.sin_port          = htons(DEFAULT_PORT);
  // NtCreateFile
  sock = socket(AF_INET, SOCK_STREAM, 0);
  printf("socket done\n");
  if (sock == INVALID_SOCKET)
    error_die("socket()");
  // sockaddr is binded on socket.
  // IOCTL_BIND
  if (bind(sock, (struct sockaddr *)&local, sizeof(local)) == SOCKET_ERROR)
    error_die("bind()");
  printf("bind done\n");
  
 listen_goto:
  // 
  if (listen(sock, 5) == SOCKET_ERROR)
    error_die("listen()");
  printf("Waiting for connection...\n");
  int count = 0;
  while (1) {
    addr_len = sizeof(client_addr);
    msg_sock = accept(sock, (struct sockaddr*)&client_addr, &addr_len);
    if (msg_sock == INVALID_SOCKET || msg_sock == -1)
      error_die("accept()");
    printf("\n\n#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$#$ %d\n\n", ++count);
    // client_addr.sin_addr
    // client_addr.sin_port
    printf("Connected to %s:%d\n", inet_ntoa(client_addr.sin_addr), htons(client_addr.sin_port));
    REQUEST *request = GetRequest(msg_sock);
    printf("Client requested %d %s\n", request->type, request->value);    
    if (request->length == 0)
      continue;
    RESPONSE *response = GetResponse(request);
    int sent = SendResponse(msg_sock, response);
    free(request);
    free(response);
    closesocket(msg_sock);    
    if (sent == 0)
      break;
    else if (sent == -1)
      goto listen_goto;
  }  
  WSACleanup();
  
}