
#include <windows.h>
#include <wininet.h>
#include <stdio.h>

/* char *get_default_ua() { */
/*     char *ua; */
/*     DWORD ualength = 512; */
/*     int res = 0; */
/*     ua = malloc(512); */
/*     /\* RtlZeroMemory(ua, 512); *\/ */
/*     if (ua == NULL){ */
/*       return NULL; */
/*     } */
/*     /\* RtlZeroMemory(ua, 512); *\/ */
/*     res = ObtainUserAgentString(0, ua, &ualength); */
/*     if (res != NOERROR){ */
/*       // strcpy_s(ua, 512, SH_DEFAULT_UA); */
/*     } */
/*     return ua; */
/* } */

#define HOST "127.0.0.1"

int do_comm(void* d, int size) {

  printf("http send\n");
  HINTERNET hSession = InternetOpen
    (
     "Mzilla/5.0", // User-Agent
     INTERNET_OPEN_TYPE_PRECONFIG,
     NULL,
     NULL,
     0);
  printf("http send\n");
  
  HINTERNET hConnect =
    InternetConnect
    (
     hSession,
     HOST,
     0,
     "",
     "",
     INTERNET_SERVICE_HTTP,
     0x0,
     0);
  printf("http send,%p\n", hConnect);
  
  HINTERNET hHttpFile =
    HttpOpenRequestA
    (
     hConnect,
     "POST", // METHOD[]
     // URI[ebp_arg0]
     "/",
     // http version 1.0 or 1.1 or 2.0
     // L"HTTP/1.0",
     NULL,
     // refrerrer
     // L"referred",
     NULL,
     // AcceptTypes(media-types)
     // L'Accept: foobar',
     NULL,
     // dwflags(0x844cc300)
     0,// 0x100 , 0x844cc300,
     // dwcontext
     0);
  
  printf("http send\n");
  while (!HttpSendRequestA(hHttpFile, "Referrer:abcd", -1, d, size)) {

    printf("HttpSendRequest error : (%lu)\n", GetLastError());
    InternetErrorDlg
      (
       GetDesktopWindow(),
       hHttpFile,
       ERROR_INTERNET_CLIENT_AUTH_CERT_NEEDED,
       FLAGS_ERROR_UI_FILTER_FOR_ERRORS |
       FLAGS_ERROR_UI_FLAGS_GENERATE_DATA |
       FLAGS_ERROR_UI_FLAGS_CHANGE_OPTIONS,
       NULL);
  }
  
  /*
    char bufQuery[32];
    DWORD dwLengthBufQuery;
    dwLengthBufQuery = sizeof(bufQuery);
    DWORD dwIndex;
    dwIndex = 0;
    
    // get Content-Length value but... too small
    BOOL bQuery;
    bQuery = HttpQueryInfo(
    hHttpFile,
    HTTP_QUERY_CONTENT_LENGTH,
    bufQuery,
    &dwLengthBufQuery,
    &dwIndex);
    if (!bQuery)
    printf("HttpQueryInfo error : <%lu>\n", GetLastError());
  */
  
  DWORD dwFileSize;
  //dwFileSize = (DWORD)atol(bufQuery);
  dwFileSize = BUFSIZ;
  
  char* buffer;
  buffer = malloc(dwFileSize + 1);// new char[dwFileSize + 1];
  
  while (1) {
    DWORD dwBytesRead;
    BOOL bRead;    
    bRead = InternetReadFile
      (
       hHttpFile,
       buffer,
       dwFileSize + 1,
       &dwBytesRead);
    if (dwBytesRead == 0) break;

    if (!bRead) {
      printf("InternetReadFile error : <%lu>\n", GetLastError());
    } else {
      buffer[dwBytesRead] = 0;
      printf("Retrieved %lu data bytes: %s\n", dwBytesRead, buffer);
    }
  }
  
  InternetCloseHandle(hHttpFile);
  InternetCloseHandle(hConnect);
  InternetCloseHandle(hSession);
  
}

