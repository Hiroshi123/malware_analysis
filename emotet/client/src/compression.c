
#include <stdio.h>
#include <stdint.h>
#include "zlib.h"

void* do_compress(void* in, int in_size, int* _out_size) {
  
  printf("ok\n");
  z_stream strm;
  strm.zalloc = Z_NULL;
  strm.zfree = Z_NULL;
  strm.opaque = Z_NULL;
  int flush = Z_FINISH;// Z_NO_FLUSH;
  int out_size = 0x100;
  uint8_t* out = malloc(out_size);
  memset(out, 0, out_size);
  void* r = out;
  strm.next_in = in;
  strm.avail_in = in_size;
  strm.avail_out = out_size;
  strm.next_out = out;
  int ret = deflateInit(&strm, Z_DEFAULT_COMPRESSION);
  if (ret != Z_OK)
    return ret;
  printf("a,%p\n", ret);
  
  int status;
  status = deflate(&strm, flush);
  printf("in_size:%p,out_size:%p\n", strm.avail_in, strm.avail_out);
  *_out_size = strm.avail_out;
  if (status == Z_STREAM_ERROR) {
    // break;
  }
  if (strm.avail_out == 0) {
    // break;
  }
  printf("a,%p\n", status);
  uint8_t* e = out + 0x10;
  for (;out<e;out++) {
    printf("a,%p,%p\n", out, *out);
  }
  return r;
}

void* do_decompress(void* in, int in_size) {
  
  z_stream strm;
  strm.zalloc = Z_NULL;
  strm.zfree = Z_NULL;
  strm.opaque = Z_NULL;
  int out_size = 0x100;
  uint32_t* out = malloc(out_size);
  memset(out, 0, out_size);
  void* r = out;
  // *in = 0x1234;
  strm.next_in = in;
  strm.avail_in = in_size;
  strm.next_out = out;
  strm.avail_out = out_size;
  int ret = inflateInit(&strm);
  if (ret != Z_OK)
    return ret;
  printf("a,%p\n", ret);
  
  int status = inflate(&strm, Z_FINISH);//Z_NO_FLUSH);
  printf("kkk:%p,%p,%p\n", out, *out, out_size);
  printf("%p\n", status);
  
  if (status != Z_OK) {
    printf("err,%p,%p\n", status, Z_DATA_ERROR);
  }
  return r;
}


