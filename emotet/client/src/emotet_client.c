
/* 0x1f8e CryptAcquireContextW */
/* 0x1fb4 Crypt32!CryptDecodeObjectEx */
/* 0x1fd1 CryptImportKey */

/* 0x2026 ADVAPI32!CryptGenKeyStub: */
/* 0x2044 ADVAPI32!CryptCreateHashStub: */

#include <windows.h>
#include <wincrypt.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <malloc.h>

#include "zlib.h"

/* 00695698 08 00 12 18 44 45 53 4b 54 4f 50 58 34 53 4d 43 37 50  ....DESKTOPX4SMC7P */
/* 006956aa 4c 5f 32 38 41 46 43 44 42 35 18 b9 db 06 20 01 2d f4  L_28AFCDB5.... .-. */
/* 006956bc ca 29 20 32 */

static char INFECTED_COMPUTER_NAME[] = "DESKTOPGHJK";
static char INFECTED_VOLUME_SERIAL_NUM[] = "28AFCDB5";
static char PROC_LIST[] = "wininit.exe";

void* prepare_format(int* len) {

  printf("o\n");
  int size = 0x30;
  void* _p = malloc(size);
  memset(_p, 0, size);
  uint8_t* p = _p;
  *len = size;
  // 08 00 12 18
  *(uint32_t*)p = 0x18120008;
  printf("p:%p\n", *(uint32_t*)p);
  memcpy(INFECTED_COMPUTER_NAME, p, strlen(INFECTED_COMPUTER_NAME));
  p += strlen(INFECTED_COMPUTER_NAME);
  
  // computer name
  // *p = "A";
  
  // - is converted to X
  // ComputerName(DESKTOP-(X)4SMC7PL_)
  // - is eliminated.
  // Serial number : 28AF-CDB5
  // OS major/OS minor
  // 
  // 20 01 2D
  // 4byte(f4ca2920)
  // 0x32
  
  // d905(-0x300)
  
  // 0x3A
  return _p;
}

int main() {
  
  do_encrypt_init();
  int len = 0;
  void* p1 = prepare_format(&len);
  int buf_len = 0x0;
  void* p2 = do_compress(p1, len, &buf_len);
  printf("b:%p,%p\n", len, buf_len);
  printf("before encrypt:%p\n", *(uint32_t*)p2);
  
  int _len = buf_len;
  int p3_len = 0;
  // this function does not return output as encryption function will override input buffer.
  void* d = do_encrypt(p2, 0x100, &_len);
  if (d == 0) {
    printf("encryption errror\n");
    return 1;
  }
  printf("llen:%p,%p\n", buf_len, _len);
  
  do_comm(d, 0x30);
  
  int res = do_decrypt(p2, &_len/*&buf_len*/);
  printf("after decrypt:%p\n", *(uint32_t*)p2);
  if (res == 0) {
    printf("encryption errror\n");
    return 1;
  }
  
  printf("llen:%p\n", _len);
  
  void* p3 = do_decompress(p2, _len);

  printf("d:%p,%p\n", *(uint32_t*)p3, _len);
  
  return 0;


  
  
}


